<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GulCode Community</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&family=JetBrains+Mono:wght==400;500&display=swap" rel="stylesheet">

    <style>
        /* Layout & Theme (Original) */
        body, html { margin: 0; padding: 0; font-family: 'Kanit', sans-serif; background-color: #111827; color: #e5e7eb; height: 100dvh; width: 100%; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .glass-nav { background: rgba(17, 24, 39, 0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* Scroll Area */
        #main-scroll-area { position: absolute; top: 60px; bottom: 70px; left: 0; right: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; z-index: 1; }

        /* Animations */
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .heart-pop { animation: heartBeat 0.5s ease-in-out; }
        @keyframes heartBeat { 0%, 28%, 70% { transform: scale(1); } 14%, 42% { transform: scale(1.3); } }

        /* Custom File Tabs (Original) */
        .file-tab { @apply px-3 py-2 text-xs font-mono cursor-pointer border-r border-gray-700 bg-[#2d2d2d] text-gray-400 hover:text-gray-200 transition whitespace-nowrap flex items-center gap-2; }
        .file-tab.active { @apply bg-[#1e1e1e] text-blue-400 border-t-2 border-t-blue-500; }
        .file-icon-html { color: #e34c26; }
        .file-icon-css { color: #264de4; }
        .file-icon-js { color: #f0db4f; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="view-auth" class="fixed inset-0 z-[100] flex items-center justify-center bg-gray-900 p-6 transition-opacity duration-300">
        <div class="w-full max-w-sm bg-gray-800 p-8 rounded-2xl shadow-2xl border border-gray-700">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-xl bg-gray-700 mb-4 text-3xl text-blue-500 shadow-lg">
                    <i class="fa-solid fa-cube"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">GulCode Community</h1>
            </div>
            <form class="space-y-4">
                <input type="text" id="auth-username" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-3 px-4 text-white focus:border-blue-500 outline-none" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
                <input type="password" id="auth-password" class="w-full bg-gray-900 border border-gray-600 rounded-lg py-3 px-4 text-white focus:border-blue-500 outline-none" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (6+ ‡∏ï‡∏±‡∏ß)">
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="handleAuth('login')" class="flex-1 bg-gray-700 py-3 rounded-lg text-white active:scale-95 transition">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                    <button type="button" onclick="handleAuth('register')" class="flex-1 bg-blue-600 py-3 rounded-lg text-white shadow-lg shadow-blue-900/50 active:scale-95 transition">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà</button>
                </div>
            </form>
            <p id="auth-error" class="text-center text-xs mt-4 min-h-[20px] text-red-400"></p>
        </div>
    </div>

    <!-- HEADER -->
    <header id="app-header" class="fixed top-0 left-0 right-0 h-[60px] bg-gray-900 border-b border-gray-800 flex items-center justify-between px-4 z-50 hidden">
        <div class="flex items-center gap-2 cursor-pointer" onclick="switchView('home')">
            <i class="fa-solid fa-cube text-blue-500 text-xl"></i>
            <h1 class="text-lg font-bold text-white">GulCode v2.0</h1>
        </div>
        <div class="flex items-center gap-3">
            <div class="text-right leading-tight">
                <div id="header-username" class="text-sm font-medium text-white">User</div>
                <div class="text-[10px] text-green-400">‚óè Online</div>
            </div>
            <button onclick="logout()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-400"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main id="main-scroll-area" class="hidden">
        <div class="max-w-3xl mx-auto min-h-full pb-4">
            
            <!-- VIEW: HOME (PROJECTS) -->
            <div id="view-home" class="p-4">
                <div class="sticky top-0 bg-gray-900 z-20 pb-2 pt-1">
                    <div class="relative mb-3">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-500"></i>
                        <input type="text" id="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå..." class="w-full bg-gray-800 border border-gray-700 text-white text-sm rounded-full py-2.5 pl-10 pr-4 focus:border-blue-500 outline-none">
                    </div>
                    <div class="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                        <button onclick="filterProjects('All')" class="cat-btn active shrink-0 bg-blue-600 text-white px-4 py-1.5 rounded-full text-xs font-medium shadow-md" data-cat="All">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button onclick="filterProjects('Popular')" class="cat-btn shrink-0 bg-gray-800 text-red-400 border border-gray-700 px-4 py-1.5 rounded-full text-xs font-bold" data-cat="Popular"><i class="fa-solid fa-fire mr-1"></i>‡∏¢‡∏≠‡∏î‡∏Æ‡∏¥‡∏ï</button>
                        <button onclick="filterProjects('Web')" class="cat-btn shrink-0 bg-gray-800 text-gray-400 border border-gray-700 px-4 py-1.5 rounded-full text-xs" data-cat="Web">Web</button>
                        <button onclick="filterProjects('App')" class="cat-btn shrink-0 bg-gray-800 text-gray-400 border border-gray-700 px-4 py-1.5 rounded-full text-xs" data-cat="App">App</button>
                        <button onclick="filterProjects('Game')" class="cat-btn shrink-0 bg-gray-800 text-gray-400 border border-gray-700 px-4 py-1.5 rounded-full text-xs" data-cat="Game">Game</button>
                    </div>
                </div>
                <div id="project-list" class="space-y-3 mt-2"></div>
            </div>

            <!-- VIEW: FEED (SOCIAL) -->
            <div id="view-feed" class="hidden p-4">
                <div class="sticky top-0 bg-gray-900 z-20 pb-3 pt-1 flex flex-col border-b border-gray-800 mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold text-white"><i class="fa-solid fa-hashtag text-blue-500 mr-2"></i>‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</h2>
                        <div class="flex bg-gray-800 rounded-lg p-1">
                            <button onclick="setFeedFilter('latest')" id="feed-filter-latest" class="px-3 py-1 rounded text-xs font-bold bg-blue-600 text-white transition">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
                            <button onclick="setFeedFilter('popular')" id="feed-filter-popular" class="px-3 py-1 rounded text-xs font-bold text-gray-400 hover:text-white transition"><i class="fa-solid fa-heart text-red-500 mr-1"></i>‡∏Æ‡∏¥‡∏ï</button>
                        </div>
                    </div>
                    
                    <div onclick="openPostModal(null)" class="bg-gray-800 p-4 rounded-xl border border-gray-700 active:bg-gray-700/50 cursor-pointer transition">
                        <p class="text-gray-400 text-sm"><i class="fa-solid fa-camera mr-2"></i> ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡∏à‡∏∞‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏≠‡∏∞‡πÑ‡∏£?</p>
                    </div>
                </div>
                <div id="feed-list" class="space-y-6"></div>
            </div>

            <!-- VIEW: ADD (PROJECT CREATE/EDIT) -->
            <div id="view-add" class="hidden p-4 h-full flex flex-col bg-gray-900">
                <div id="form-project" class="flex-1 flex flex-col h-full">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="font-bold text-gray-200 text-sm">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</h2>
                        <button onclick="resetForm()" class="text-xs text-gray-500 hover:text-white">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
                    </div>
                    <div class="space-y-3 flex-1 flex flex-col">
                        <input type="text" id="p-title" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:border-blue-500 outline-none" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå">
                        <div class="flex gap-2">
                            <select id="p-category" class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-gray-300 outline-none w-1/3 text-xs">
                                <option value="Web">Web</option>
                                <option value="App">App</option>
                                <option value="Game">Game</option>
                            </select>
                            <input type="text" id="p-desc" class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white w-2/3 outline-none text-sm" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢">
                        </div>
                        <!-- Editor Mode -->
                        <div class="flex bg-gray-800 p-1 rounded-lg">
                            <button onclick="setEditorMode('normal')" id="btn-mode-normal" class="flex-1 py-1.5 rounded-md text-xs font-bold bg-blue-600 text-white shadow transition">Basic</button>
                            <button onclick="setEditorMode('advanced')" id="btn-mode-advanced" class="flex-1 py-1.5 rounded-md text-xs font-bold text-gray-400 hover:text-white transition">üöÄ Advanced</button>
                        </div>
                        <!-- EDITOR -->
                        <div class="flex-1 relative border border-gray-700 rounded-lg overflow-hidden bg-[#1e1e1e] min-h-[300px] flex flex-col">
                            <div id="editor-top-bar" class="bg-[#252526] border-b border-[#333] flex items-center pr-2 hidden">
                                <div id="file-tabs-container" class="flex overflow-x-auto hide-scrollbar flex-1"></div>
                                <button onclick="openNewFileModal()" class="px-3 py-2 text-gray-400 hover:text-white border-l border-[#333]"><i class="fa-solid fa-plus"></i></button>
                                <button onclick="openEditorMenu()" class="px-3 py-2 text-gray-400 hover:text-white border-l border-[#333]"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                            </div>
                            <div class="relative flex-1">
                                <textarea id="code-editor" class="absolute inset-0 w-full h-full p-3 bg-[#1e1e1e] text-gray-300 font-mono text-sm resize-none focus:outline-none" spellcheck="false" placeholder="// Code here..."></textarea>
                            </div>
                        </div>
                        <button onclick="saveProject()" id="btn-save-project" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg mt-2 text-sm"><i class="fa-solid fa-paper-plane mr-2"></i> ‡∏•‡∏á‡∏á‡∏≤‡∏ô</button>
                    </div>
                </div>
            </div>
            
            <!-- VIEW: PROFILE -->
            <div id="view-profile" class="hidden p-6 flex flex-col items-center justify-center h-full">
                <div class="w-20 h-20 rounded-full bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center text-3xl text-white mb-3 shadow-xl"><i class="fa-solid fa-user-astronaut"></i></div>
                <h2 id="profile-name" class="text-xl font-bold text-white">User</h2>
                <div class="flex gap-4 mt-6 w-full max-w-xs">
                    <div class="flex-1 bg-gray-800 rounded-lg p-3 text-center border border-gray-700">
                        <div class="text-gray-400 text-xs mb-1">‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå</div>
                        <div id="stats-projects" class="font-bold text-blue-400 text-xl">0</div>
                    </div>
                    <div class="flex-1 bg-gray-800 rounded-lg p-3 text-center border border-gray-700">
                        <div class="text-gray-400 text-xs mb-1">‡πÇ‡∏û‡∏™‡∏ï‡πå</div>
                        <div id="stats-posts" class="font-bold text-green-400 text-xl">0</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- BOTTOM NAV -->
    <nav id="app-nav" class="fixed bottom-0 left-0 right-0 h-[70px] glass-nav z-50 flex justify-around items-center pb-2 hidden">
        <button onclick="switchView('home')" class="nav-btn active w-1/4 flex flex-col items-center justify-center py-2 text-blue-500"><i class="fa-solid fa-code text-xl mb-1"></i><span class="text-[10px]">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span></button>
        <button onclick="switchView('feed')" class="nav-btn w-1/4 flex flex-col items-center justify-center py-2 text-gray-500"><i class="fa-solid fa-hashtag text-xl mb-1"></i><span class="text-[10px]">‡∏ü‡∏µ‡∏î</span></button>
        <button onclick="openAddMode()" class="nav-btn w-1/4 flex flex-col items-center justify-center py-2 text-gray-500 relative">
            <div class="absolute -top-5 bg-blue-600 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg border-4 border-gray-900 active:scale-90 transition"><i class="fa-solid fa-plus text-xl"></i></div>
            <span class="text-[10px] mt-6">‡∏•‡∏á‡∏á‡∏≤‡∏ô</span>
        </button>
        <button onclick="switchView('profile')" class="nav-btn w-1/4 flex flex-col items-center justify-center py-2 text-gray-500"><i class="fa-solid fa-user text-xl mb-1"></i><span class="text-[10px]">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span></button>
    </nav>

    <!-- MODALS -->
    
    <!-- NEW FILE MODAL -->
    <div id="modal-new-file" class="fixed inset-0 z-[110] bg-black/90 flex items-center justify-center hidden fade-in">
        <div class="bg-gray-800 w-[80%] max-w-xs p-6 rounded-2xl border border-gray-700">
            <h3 class="text-white font-bold mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà</h3>
            <input type="text" id="new-file-name" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white text-sm mb-3" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå (‡πÄ‡∏ä‡πà‡∏ô style)">
            <select id="new-file-type" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white text-sm mb-3">
                <option value="html">.html</option>
                <option value="css">.css</option>
                <option value="js">.js</option>
            </select>
            <button onclick="addNewFile()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 rounded text-sm font-bold mb-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå</button>
            <button onclick="document.getElementById('modal-new-file').classList.add('hidden')" class="w-full text-gray-400 text-xs py-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <!-- POST CREATE/EDIT MODAL -->
    <div id="modal-post-edit" class="fixed inset-0 z-[115] bg-black/90 flex items-center justify-center hidden transition-opacity duration-200 fade-in">
        <div class="bg-gray-800 w-[90%] max-w-lg p-6 rounded-2xl border border-gray-700 flex flex-col">
            <h3 id="post-modal-title" class="text-white font-bold mb-4 text-lg">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà</h3>
            <textarea id="edit-post-content" class="w-full flex-1 bg-gray-900 border border-gray-700 rounded-xl p-4 text-white text-base resize-none focus:border-blue-500 outline-none placeholder-gray-500 mb-4 h-40" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏´‡∏ô‡πà‡∏≠‡∏¢..."></textarea>
            
            <div id="edit-post-img-preview-container" class="relative hidden mb-4 rounded-xl overflow-hidden border border-gray-700 bg-black">
                <img id="edit-post-img-preview" src="" class="w-full max-h-60 object-contain mx-auto">
                <button onclick="clearPostImageEdit()" class="absolute top-2 right-2 bg-black/60 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-red-500 transition"><i class="fa-solid fa-times"></i></button>
            </div>

            <div class="flex items-center gap-3 mt-auto pt-4 border-t border-gray-700">
                <label class="cursor-pointer text-gray-400 hover:text-green-400 transition p-2 bg-gray-900 rounded-lg border border-gray-700">
                    <i class="fa-solid fa-image text-xl"></i>
                    <input type="file" id="edit-post-img-input" accept="image/*" class="hidden" onchange="handlePostImageEdit(this)">
                </label>
                <div class="flex-1 text-xs text-gray-500">
                    <button onclick="removeImageIfEditing()" id="btn-remove-post-image" class="text-red-400 hover:text-red-300 hidden">‡∏•‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°</button>
                </div>
                <button onclick="closePostModal()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2.5 px-6 rounded-xl transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="savePost()" id="btn-save-post" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2.5 px-6 rounded-xl shadow-lg transition">‡πÇ‡∏û‡∏™‡∏ï‡πå</button>
            </div>
        </div>
    </div>

    <!-- COMMENT MODAL -->
    <div id="modal-comments" class="fixed inset-0 z-[110] bg-black/80 flex flex-col justify-end sm:justify-center hidden transition-opacity duration-200" onclick="if(event.target===this) closeComments()">
        <div id="comment-panel" class="bg-gray-800 w-full sm:max-w-md mx-auto sm:rounded-2xl rounded-t-2xl h-[60vh] flex flex-col border-t border-gray-700 transform translate-y-full transition-transform duration-300">
            <div class="flex justify-between items-center p-3 border-b border-gray-700">
                <span class="text-white font-bold text-sm">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</span>
                <button onclick="closeComments()" class="text-gray-400"><i class="fa-solid fa-chevron-down"></i></button>
            </div>
            <div id="comment-list" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
            <div class="p-3 bg-gray-900 border-t border-gray-700 flex gap-2">
                <input type="text" id="comment-input" class="flex-1 bg-gray-800 border border-gray-600 rounded-full px-4 py-2 text-white text-sm focus:border-blue-500 outline-none" placeholder="‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô...">
                <button onclick="sendComment()" class="bg-blue-600 w-9 h-9 rounded-full text-white flex items-center justify-center"><i class="fa-solid fa-paper-plane text-xs"></i></button>
            </div>
        </div>
    </div>

    <!-- EDITOR MENU -->
    <div id="modal-editor-menu" class="fixed inset-0 z-[105] bg-black/80 flex items-end sm:items-center justify-center hidden fade-in" onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="bg-gray-800 w-full sm:w-[300px] rounded-t-2xl sm:rounded-2xl p-4 border-t sm:border border-gray-700">
            <div class="space-y-2">
                <p class="text-gray-500 text-xs text-center mb-2 font-mono" id="current-file-label">index.html</p>
                <button onclick="openImageTool(); document.getElementById('modal-editor-menu').classList.add('hidden')" class="w-full bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg flex items-center px-4 text-sm"><i class="fa-solid fa-image text-yellow-400 mr-3"></i> ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î</button>
                <button onclick="deleteCurrentFile()" id="btn-delete-file" class="w-full bg-red-900/30 hover:bg-red-900/50 text-red-400 py-3 rounded-lg flex items-center px-4 text-sm mt-2"><i class="fa-solid fa-trash mr-3"></i> ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ</button>
            </div>
        </div>
    </div>

    <!-- IMAGE TOOL MODAL -->
    <div id="modal-image" class="fixed inset-0 z-[120] bg-black/90 flex items-center justify-center hidden fade-in">
        <div class="bg-gray-800 w-[90%] max-w-md p-6 rounded-2xl border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white font-bold">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h3>
                <button onclick="document.getElementById('modal-image').classList.add('hidden')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <input type="file" id="img-tool-input" accept="image/*" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-500"/>
            <div id="img-tool-preview" class="hidden mt-4">
                <textarea id="base64-output" class="w-full h-20 bg-black text-green-400 text-[10px] font-mono p-2 rounded resize-none mb-2" readonly></textarea>
                <button onclick="copyBase64()" class="w-full bg-gray-700 text-white py-2 rounded text-xs">Copy Code</button>
            </div>
        </div>
    </div>

    <!-- DELETE CONFIRM MODAL -->
    <div id="modal-delete" class="fixed inset-0 z-[130] bg-black/80 flex items-center justify-center hidden fade-in">
        <div class="bg-gray-800 p-6 rounded-2xl w-[80%] max-w-xs text-center border border-gray-700">
            <div class="w-12 h-12 bg-red-500/20 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fa-solid fa-trash"></i></div>
            <h3 class="text-white font-bold text-lg mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?</h3>
            <div class="flex gap-3 mt-6">
                <button onclick="closeDeleteModal()" class="flex-1 py-2 bg-gray-700 text-white rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="confirmDelete()" class="flex-1 py-2 bg-red-600 text-white rounded-lg">‡∏•‡∏ö‡πÄ‡∏•‡∏¢</button>
            </div>
        </div>
    </div>

    <!-- DETAIL OVERLAY -->
    <div id="view-detail" class="fixed inset-0 bg-gray-900 z-[60] flex flex-col hidden">
        <div class="flex justify-between items-center p-3 border-b border-gray-800 h-[60px]">
            <button onclick="closeDetail()" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-white"><i class="fa-solid fa-arrow-left text-lg"></i></button>
            <div class="text-center"><h2 id="d-title" class="font-bold text-white text-sm">Title</h2></div>
            <div class="flex items-center">
                <!-- NEW: Edit Button -->
                <button id="btn-edit-project" onclick="editCurrentProject()" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-yellow-400 hidden"><i class="fa-solid fa-pen text-sm"></i></button>
                <button onclick="copyCode()" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-blue-400"><i class="fa-regular fa-copy text-lg"></i></button>
            </div>
        </div>
        <div class="flex h-[40px] border-b border-gray-800 bg-gray-900 text-sm">
            <button onclick="switchDetailTab('preview')" id="tab-preview" class="flex-1 text-blue-400 border-b-2 border-blue-500 bg-gray-800/50">Play</button>
            <button onclick="switchDetailTab('code')" id="tab-code" class="flex-1 text-gray-500">Code</button>
        </div>
        <div class="flex-1 relative bg-black">
            <div id="content-preview" class="absolute inset-0 w-full h-full bg-white"><iframe id="preview-frame" class="w-full h-full border-none"></iframe></div>
            <div id="content-code" class="absolute inset-0 w-full h-full bg-[#1e1e1e] overflow-auto hidden p-4"><pre><code id="code-display" class="font-mono text-sm text-blue-300 whitespace-pre-wrap"></code></pre></div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 border border-gray-600 text-white px-6 py-3 rounded-full shadow-2xl z-[200] flex items-center gap-3 transition-all duration-300 opacity-0 pointer-events-none">
        <i class="fa-solid fa-circle-check text-green-400"></i><span id="toast-msg">Success</span>
    </div>

    <!-- JS Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, doc, updateDoc, deleteDoc, arrayUnion, arrayRemove, increment } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCO0XsFGLW7EiQ1XQA4haJBOpxhcjA9cCo",
            authDomain: "kkr-gulcode-community.firebaseapp.com",
            projectId: "kkr-gulcode-community",
            storageBucket: "kkr-gulcode-community.firebasestorage.app",
            messagingSenderId: "533732629666",
            appId: "1:533732629666:web:5da28cf53b6051f8048bfb"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const DOMAIN_SUFFIX = "@gulcode.community";

        let currentUser = null;
        let allProjects = [];
        let allPosts = [];
        let currentCategory = 'All';
        let feedFilter = 'latest';
        
        // State for Editing
        let editingId = null; 
        let editingPostId = null;
        let currentPostImg = null;
        let currentProjectData = null; 
        let deletingTarget = { id: null, type: null }; 
        let activeCommentPostId = null;
        
        let editorMode = 'normal'; 
        let currentFiles = []; 
        let activeFileIndex = 0;

        // --- AUTH ---
        window.handleAuth = async (mode) => {
            const u = document.getElementById('auth-username').value.trim();
            const p = document.getElementById('auth-password').value;
            const err = document.getElementById('auth-error');
            if(u.length < 3 || p.length < 6) { err.innerText = "‡∏ä‡∏∑‡πà‡∏≠ 3+ ‡∏ï‡∏±‡∏ß / ‡∏£‡∏´‡∏±‡∏™ 6+ ‡∏ï‡∏±‡∏ß"; return; }
            const email = u.toLowerCase().replace(/\s/g, '') + DOMAIN_SUFFIX;
            err.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
            try {
                if(mode === 'register') {
                    const cred = await createUserWithEmailAndPassword(auth, email, p);
                    await updateProfile(cred.user, { displayName: u });
                } else {
                    await signInWithEmailAndPassword(auth, email, p);
                }
            } catch(e) { err.innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î)"; console.error(e); }
        };
        window.logout = () => signOut(auth).then(() => location.reload());
        
        onAuthStateChanged(auth, user => {
            if(user) {
                currentUser = user;
                document.getElementById('view-auth').classList.add('hidden');
                document.getElementById('app-header').classList.remove('hidden');
                document.getElementById('app-nav').classList.remove('hidden');
                document.getElementById('main-scroll-area').classList.remove('hidden');
                document.getElementById('header-username').innerText = user.displayName;
                document.getElementById('profile-name').innerText = user.displayName;
                setupDB();
                setEditorMode('normal'); 
            } else { document.getElementById('view-auth').classList.remove('hidden'); }
        });

        // --- DB Listener ---
        function setupDB() {
            const qP = query(collection(db, 'projects'));
            onSnapshot(qP, snapshot => {
                allProjects = [];
                let myCount = 0;
                snapshot.forEach(doc => {
                    const d = doc.data();
                    allProjects.push({ id: doc.id, ...d });
                    if(d.authorId === (currentUser?.uid || '')) myCount++;
                });
                document.getElementById('stats-projects').innerText = myCount;
                renderProjects();
            });

            const qFeed = query(collection(db, 'posts'));
            onSnapshot(qFeed, snapshot => {
                allPosts = [];
                let myCount = 0;
                snapshot.forEach(doc => {
                    const d = doc.data();
                    allPosts.push({ id: doc.id, ...d });
                    if(d.authorId === (currentUser?.uid || '')) myCount++;
                });
                document.getElementById('stats-posts').innerText = myCount;
                renderFeed();
                
                if(activeCommentPostId) {
                    const p = allPosts.find(x => x.id === activeCommentPostId);
                    if(p) renderCommentsList(p.comments || []);
                }
            });
        }

        // --- RENDER: PROJECTS ---
        window.renderProjects = () => {
            const searchTerm = document.getElementById('search-input').value.trim().toLowerCase();
            const list = document.getElementById('project-list');
            list.innerHTML = '';
            
            let filtered;
            if (currentCategory === 'Popular') filtered = [...allProjects].sort((a, b) => (b.likes || 0) - (a.likes || 0));
            else {
                filtered = currentCategory === 'All' ? allProjects : allProjects.filter(p => p.category === currentCategory);
                filtered.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
            }
            
            if (searchTerm) filtered = filtered.filter(p => p.title.toLowerCase().includes(searchTerm) || p.authorName.toLowerCase().includes(searchTerm));
            
            if(filtered.length === 0) { list.innerHTML = '<div class="text-center text-gray-600 py-10 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>'; return; }

            filtered.forEach(p => {
                const isOwner = currentUser && p.authorId === currentUser.uid;
                const isLiked = p.likedBy && p.likedBy.includes(currentUser.uid);
                let icon = 'fa-code'; let col = 'text-blue-400 bg-blue-900/20';
                if(p.category === 'Game') { icon = 'fa-gamepad'; col = 'text-purple-400 bg-purple-900/20'; }
                if(p.category === 'App') { icon = 'fa-mobile-screen'; col = 'text-green-400 bg-green-900/20'; }
                
                const safeP = JSON.stringify(p).replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                const html = `
                <div onclick='openDetail(${safeP})' class="bg-gray-800 p-4 rounded-xl border border-gray-700 hover:border-gray-600 active:scale-[0.99] transition-all cursor-pointer shadow-sm flex items-center justify-between group fade-in">
                    <div class="flex items-center gap-3 overflow-hidden flex-1">
                        <div class="w-10 h-10 rounded-lg ${col} flex items-center justify-center text-lg shrink-0"><i class="fa-solid ${icon}"></i></div>
                        <div class="min-w-0 flex-1">
                            <h3 class="font-bold text-gray-200 text-sm truncate flex items-center">${p.title} ${p.mode === 'advanced' ? '<span class="ml-2 text-[8px] bg-purple-600 px-1 rounded">ADV</span>' : ''}</h3>
                            <p class="text-[10px] text-gray-500 truncate flex items-center gap-1"><i class="fa-regular fa-user"></i> ${p.authorName}</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <button onclick="event.stopPropagation(); toggleLikeProject('${p.id}')" class="flex flex-col items-center justify-center w-8 h-8 rounded-full hover:bg-gray-700/50 transition mr-1">
                            <i class="${isLiked ? 'fa-solid text-red-500 heart-pop' : 'fa-regular text-gray-500'} fa-heart transition-colors"></i>
                            <span class="text-[9px] ${isLiked ? 'text-red-400' : 'text-gray-500'}">${p.likes || 0}</span>
                        </button>
                        ${isOwner ? `
                            <button onclick="event.stopPropagation(); openEditProject('${p.id}')" class="w-8 h-8 rounded text-gray-400 hover:text-yellow-400 hover:bg-gray-700/50 flex items-center justify-center transition"><i class="fa-solid fa-pen text-xs"></i></button>
                            <button onclick="event.stopPropagation(); promptDelete('${p.id}', 'project')" class="w-8 h-8 rounded text-gray-400 hover:text-red-400 hover:bg-gray-700/50 flex items-center justify-center transition"><i class="fa-solid fa-trash text-xs"></i></button>
                        ` : ''}
                    </div>
                </div>`;
                list.insertAdjacentHTML('beforeend', html);
            });
        }

        // --- RENDER: FEED ---
        window.setFeedFilter = (f) => {
            feedFilter = f;
            document.getElementById('feed-filter-latest').className = f==='latest' ? "px-3 py-1 rounded text-xs font-bold bg-blue-600 text-white transition" : "px-3 py-1 rounded text-xs font-bold text-gray-400 hover:text-white transition";
            document.getElementById('feed-filter-popular').className = f==='popular' ? "px-3 py-1 rounded text-xs font-bold bg-gray-700 text-red-400 border border-red-900/50 transition" : "px-3 py-1 rounded text-xs font-bold text-gray-400 hover:text-white transition";
            renderFeed();
        };

        window.renderFeed = () => {
            const list = document.getElementById('feed-list');
            list.innerHTML = '';
            
            let items = [...allPosts];
            if(feedFilter === 'popular') items.sort((a,b) => (b.likes||0) - (a.likes||0));
            else items.sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0));

            if(items.length === 0) { list.innerHTML = '<div class="text-center text-gray-500 py-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå</div>'; return; }

            items.forEach(p => {
                const isOwner = currentUser && p.authorId === currentUser.uid;
                const isLiked = p.likedBy && p.likedBy.includes(currentUser.uid);
                
                list.innerHTML += `
                <div class="bg-gray-800 rounded-xl border border-gray-700 p-4 fade-in">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-gray-700 to-gray-600 flex items-center justify-center text-[10px] font-bold border border-gray-600">${p.authorName.substr(0,2).toUpperCase()}</div>
                            <div>
                                <div class="text-sm font-bold text-gray-200 leading-none">${p.authorName}</div>
                                <div class="text-[10px] text-gray-500 mt-1">${timeAgo(p.timestamp)}</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${isOwner ? `<button onclick="openPostModal('${p.id}')" class="text-gray-500 hover:text-yellow-400 w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-pen text-xs"></i></button>` : ''}
                            ${isOwner ? `<button onclick="promptDelete('${p.id}', 'post')" class="text-gray-500 hover:text-red-400 w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-trash text-xs"></i></button>` : ''}
                        </div>
                    </div>
                    <div class="text-sm text-gray-300 mb-3 whitespace-pre-wrap leading-relaxed">${p.content}</div>
                    ${p.imageUrl ? `<div class="mb-3 rounded-lg overflow-hidden bg-black/50 border border-gray-700/50"><img src="${p.imageUrl}" class="w-full max-h-80 object-contain" loading="lazy"></div>` : ''}
                    <div class="flex items-center gap-4 pt-2 border-t border-gray-700/50">
                        <button onclick="toggleLikePost('${p.id}')" class="flex items-center gap-2 text-xs ${isLiked ? 'text-red-400' : 'text-gray-400'} hover:text-red-400 transition">
                            <i class="${isLiked ? 'fa-solid heart-pop' : 'fa-regular'} fa-heart text-base"></i> ${p.likes || 0}
                        </button>
                        <button onclick="openComments('${p.id}')" class="flex items-center gap-2 text-xs text-gray-400 hover:text-blue-400 transition">
                            <i class="fa-regular fa-comment text-base"></i> ${(p.comments||[]).length}
                        </button>
                    </div>
                </div>`;
            });
        };

        // --- EDITOR LOGIC ---
        window.setEditorMode = (mode) => {
            editorMode = mode;
            document.getElementById('btn-mode-normal').className = mode==='normal'?"flex-1 py-1.5 rounded-md text-xs font-bold bg-blue-600 text-white shadow transition":"flex-1 py-1.5 rounded-md text-xs font-bold text-gray-400 hover:text-white transition";
            document.getElementById('btn-mode-advanced').className = mode==='advanced'?"flex-1 py-1.5 rounded-md text-xs font-bold bg-purple-600 text-white shadow transition":"flex-1 py-1.5 rounded-md text-xs font-bold text-gray-400 hover:text-white transition";
            
            const topBar = document.getElementById('editor-top-bar');
            if(mode === 'normal') {
                topBar.classList.add('hidden');
                currentFiles = [{ name: 'index.html', type: 'html', content: '' }];
                activeFileIndex = 0;
                renderEditorContent();
            } else {
                topBar.classList.remove('hidden');
                if(currentFiles.length <= 1 && currentFiles[0].name === 'index.html' && !currentFiles[0].content) {
                    currentFiles = [
                        { name: "index.html", type: "html", content: "<!DOCTYPE html>\n<html>\n<body>\n  <h1>Hello</h1>\n  <script src=\"script.js\"><" + "/script>\n</body>\n</html>" },
                        { name: "script.js", type: "js", content: "console.log('Ready');" }
                    ];
                }
                renderTabs();
                renderEditorContent();
            }
        };

        window.renderTabs = () => {
            const c = document.getElementById('file-tabs-container'); c.innerHTML = '';
            currentFiles.forEach((f, i) => {
                let ic = 'fa-file';
                if(f.type==='html') ic = 'fa-brands fa-html5 file-icon-html';
                if(f.type==='css') ic = 'fa-brands fa-css3-alt file-icon-css';
                if(f.type==='js') ic = 'fa-brands fa-js file-icon-js';
                const d = document.createElement('div'); d.className = `file-tab ${i===activeFileIndex?'active':''}`;
                d.onclick = () => switchFile(i);
                d.innerHTML = `<i class="${ic}"></i> ${f.name}`;
                c.appendChild(d);
            });
        };

        window.switchFile = (i) => { currentFiles[activeFileIndex].content = document.getElementById('code-editor').value; activeFileIndex = i; renderTabs(); renderEditorContent(); };
        window.renderEditorContent = () => { document.getElementById('code-editor').value = currentFiles[activeFileIndex].content || ''; };
        window.openNewFileModal = () => document.getElementById('modal-new-file').classList.remove('hidden');
        window.addNewFile = () => {
            const name = document.getElementById('new-file-name').value.trim();
            const type = document.getElementById('new-file-type').value;
            if(!name) return showToast("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå", true);
            currentFiles.push({ name: name.endsWith('.'+type)?name:name+'.'+type, type: type, content: '' });
            document.getElementById('modal-new-file').classList.add('hidden');
            currentFiles[activeFileIndex].content = document.getElementById('code-editor').value;
            activeFileIndex = currentFiles.length - 1;
            renderTabs(); renderEditorContent();
        };
        window.openEditorMenu = () => {
            document.getElementById('current-file-label').innerText = currentFiles[activeFileIndex].name;
            document.getElementById('btn-delete-file').style.display = currentFiles.length > 1 ? 'flex' : 'none';
            document.getElementById('modal-editor-menu').classList.remove('hidden');
        };
        window.deleteCurrentFile = () => {
            if(currentFiles.length <= 1) return;
            currentFiles.splice(activeFileIndex, 1);
            activeFileIndex = Math.max(0, activeFileIndex - 1);
            renderTabs(); renderEditorContent();
            document.getElementById('modal-editor-menu').classList.add('hidden');
        };

        // --- PROJECT EDIT LOGIC ---
        // New helper to edit from list directly
        window.openEditProject = (id) => {
            const p = allProjects.find(x => x.id === id);
            if(!p) return;
            currentProjectData = p; // Set global state
            editCurrentProject(); // Reuse logic
        };

        window.editCurrentProject = () => {
            if (!currentProjectData) return;
            editingId = currentProjectData.id;
            
            document.getElementById('p-title').value = currentProjectData.title;
            document.getElementById('p-desc').value = currentProjectData.description;
            document.getElementById('p-category').value = currentProjectData.category;
            setEditorMode(currentProjectData.mode);
            
            currentFiles = currentProjectData.files;
            activeFileIndex = 0;
            renderTabs();
            renderEditorContent();
            
            document.getElementById('btn-save-project').innerHTML = '<i class="fa-solid fa-upload mr-2"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå';
            
            closeDetail(); 
            switchView('add'); 
        };

        // --- ADD/EDIT PROJECT ---
        window.saveProject = async () => {
            currentFiles[activeFileIndex].content = document.getElementById('code-editor').value;
            const t = document.getElementById('p-title').value.trim();
            if(!t) return showToast("‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå", true);
            
            let main = currentFiles.find(f => f.type==='html') || currentFiles[0];
            let code = main.content;
            currentFiles.filter(f=>f.type==='css').forEach(c=> { code = code.replace(new RegExp(`<link[^>]+href=["']${c.name}["'][^>]*>`, 'gi'), `<style>${c.content}</style>`); });
            currentFiles.filter(f=>f.type==='js').forEach(j=> { code = code.replace(new RegExp(`<script[^>]+src=["']${j.name}["'][^>]*><`+'/script>', 'gi'), () => `<script>${j.content}<`+'/script>'); });

            const projectData = {
                title: t, description: document.getElementById('p-desc').value, category: document.getElementById('p-category').value,
                mode: editorMode, files: currentFiles, code: code,
                authorId: currentUser.uid, authorName: currentUser.displayName,
            };
            
            try {
                if (editingId) {
                    await updateDoc(doc(db, 'projects', editingId), projectData); 
                    showToast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                } else {
                    await addDoc(collection(db, 'projects'), {
                        ...projectData,
                        timestamp: serverTimestamp(), likes: 0, likedBy: []
                    });
                    showToast("‡∏•‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                }
                
                resetForm(); 
                switchView('home');
            } catch(e) { 
                showToast("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", true); 
                console.error(e);
            }
        };

        // --- POST CREATE/EDIT LOGIC ---
        window.handlePostImageEdit = (input) => {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_SIZE = 800;
                        const scale = MAX_SIZE / Math.max(img.width, 800);
                        canvas.width = img.width * scale; canvas.height = img.height * scale;
                        canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
                        currentPostImg = canvas.toDataURL('image/jpeg', 0.7); 
                        document.getElementById('edit-post-img-preview').src = currentPostImg;
                        document.getElementById('edit-post-img-preview-container').classList.remove('hidden');
                        document.getElementById('btn-remove-post-image').classList.add('hidden');
                    };
                };
                reader.readAsDataURL(input.files[0]);
            }
        };
        window.clearPostImageEdit = () => { 
            currentPostImg = null; 
            document.getElementById('edit-post-img-input').value=''; 
            document.getElementById('edit-post-img-preview-container').classList.add('hidden'); 
            document.getElementById('btn-remove-post-image').classList.add('hidden');
        };
        window.removeImageIfEditing = () => {
            currentPostImg = "REMOVE_IMAGE_FLAG";
            document.getElementById('edit-post-img-preview-container').classList.add('hidden');
            document.getElementById('btn-remove-post-image').classList.add('hidden');
            document.getElementById('edit-post-img-input').value = '';
            showToast("‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï");
        };

        window.openPostModal = (id = null) => {
            editingPostId = id;
            currentPostImg = null; 
            const isEditing = id !== null;
            const postModal = document.getElementById('modal-post-edit');
            const title = document.getElementById('post-modal-title');
            const contentInput = document.getElementById('edit-post-content');
            const saveButton = document.getElementById('btn-save-post');
            const removeImgBtn = document.getElementById('btn-remove-post-image');
            
            title.innerText = isEditing ? "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏û‡∏™‡∏ï‡πå" : "‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà";
            saveButton.innerHTML = isEditing ? "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï" : "‡πÇ‡∏û‡∏™‡∏ï‡πå";
            
            if (isEditing) {
                const post = allPosts.find(p => p.id === id);
                if (!post) return showToast("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå", true);
                contentInput.value = post.content;
                currentPostImg = post.imageUrl || null;
                if (post.imageUrl) {
                    document.getElementById('edit-post-img-preview').src = post.imageUrl;
                    document.getElementById('edit-post-img-preview-container').classList.remove('hidden');
                    removeImgBtn.classList.remove('hidden');
                } else { clearPostImageEdit(); }
            } else {
                contentInput.value = '';
                clearPostImageEdit();
            }
            postModal.classList.remove('hidden');
        };

        window.closePostModal = () => {
            document.getElementById('modal-post-edit').classList.add('hidden');
            editingPostId = null;
            clearPostImageEdit();
        };

        window.savePost = async () => {
            const content = document.getElementById('edit-post-content').value.trim();
            if(!content && !currentPostImg && currentPostImg !== "REMOVE_IMAGE_FLAG") return showToast("‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ", true);
            const postData = { content };
            if (currentPostImg === "REMOVE_IMAGE_FLAG") {
                postData.imageUrl = null; 
            } else if (currentPostImg && currentPostImg.startsWith('data:')) {
                postData.imageUrl = currentPostImg; 
            } else if (!editingPostId && currentPostImg) {
                 postData.imageUrl = currentPostImg; 
            }

            try {
                if (editingPostId) {
                    await updateDoc(doc(db, 'posts', editingPostId), postData);
                    showToast("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                } else {
                    await addDoc(collection(db, 'posts'), {
                        ...postData,
                        authorId: currentUser.uid, authorName: currentUser.displayName, timestamp: serverTimestamp(), likes: 0, likedBy: [], comments: []
                    });
                    showToast("‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                }
                closePostModal();
            } catch(e) { 
                showToast("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏û‡∏™‡∏ï‡πå", true); 
                console.error(e);
            }
        };


        // --- INTERACTION LOGIC ---
        window.toggleLikeProject = async (id) => toggleLikeGeneric('projects', id);
        window.toggleLikePost = async (id) => toggleLikeGeneric('posts', id);

        async function toggleLikeGeneric(coll, id) {
            if(!currentUser) return;
            const item = (coll==='projects'?allProjects:allPosts).find(x=>x.id===id);
            const isLiked = item.likedBy && item.likedBy.includes(currentUser.uid);
            const ref = doc(db, coll, id);
            await updateDoc(ref, { likes: increment(isLiked?-1:1), likedBy: isLiked?arrayRemove(currentUser.uid):arrayUnion(currentUser.uid) });
        }

        window.openComments = (id) => {
            activeCommentPostId = id;
            document.getElementById('modal-comments').classList.remove('hidden');
            setTimeout(()=>document.getElementById('comment-panel').classList.remove('translate-y-full'), 10);
            const p = allPosts.find(x=>x.id===id);
            if(p) renderCommentsList(p.comments||[]);
        };
        window.closeComments = () => {
            document.getElementById('comment-panel').classList.add('translate-y-full');
            setTimeout(()=>document.getElementById('modal-comments').classList.add('hidden'), 300);
            activeCommentPostId = null;
        };
        function renderCommentsList(list) {
            const c = document.getElementById('comment-list'); c.innerHTML = '';
            if(list.length===0) c.innerHTML = '<div class="text-gray-500 text-center text-xs mt-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</div>';
            list.sort((a,b) => (a.timestamp || 0) - (b.timestamp || 0)); 
            list.forEach(x => {
                c.innerHTML += `<div class="flex gap-2"><div class="font-bold text-blue-400 text-xs whitespace-nowrap">${x.userName}:</div><div class="text-gray-300 text-xs">${x.text}</div></div>`;
            });
            c.scrollTop = c.scrollHeight;
        }
        window.sendComment = async () => {
            const txt = document.getElementById('comment-input').value.trim();
            if(!txt || !activeCommentPostId) return;
            await updateDoc(doc(db, 'posts', activeCommentPostId), { comments: arrayUnion({ userId: currentUser.uid, userName: currentUser.displayName, text: txt, timestamp: Date.now() }) });
            document.getElementById('comment-input').value='';
        };

        // --- GENERAL UTILS ---
        window.switchView = (v) => {
            ['home','feed','add','profile'].forEach(x=>document.getElementById('view-'+x).classList.add('hidden'));
            document.getElementById('view-'+v).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b=>{ b.classList.remove('text-blue-500'); b.classList.add('text-gray-500'); });
            if(v==='home') document.querySelectorAll('.nav-btn')[0].classList.replace('text-gray-500','text-blue-500');
            if(v==='feed') document.querySelectorAll('.nav-btn')[1].classList.replace('text-gray-500','text-blue-500');
            if(v==='profile') document.querySelectorAll('.nav-btn')[3].classList.replace('text-gray-500','text-blue-500');
        };
        window.openAddMode = () => { switchView('add'); resetForm(); }; 
        window.resetForm = () => {
            editingId = null;
            currentProjectData = null;
            document.getElementById('p-title').value=''; document.getElementById('p-desc').value=''; document.getElementById('code-editor').value='';
            setEditorMode('normal');
            document.getElementById('btn-save-project').innerHTML = '<i class="fa-solid fa-paper-plane mr-2"></i> ‡∏•‡∏á‡∏á‡∏≤‡∏ô';
        };
        window.filterProjects = (c) => { 
            currentCategory = c; 
            document.querySelectorAll('.cat-btn').forEach(b => {
                if(b.dataset.cat === c) b.className = "cat-btn active shrink-0 bg-blue-600 text-white px-4 py-1.5 rounded-full text-xs font-medium shadow-md";
                else b.className = "cat-btn shrink-0 bg-gray-800 text-gray-400 border border-gray-700 px-4 py-1.5 rounded-full text-xs";
                if(b.dataset.cat === 'Popular') b.classList.add(b.dataset.cat===c?'bg-red-600':'text-red-400');
            });
            renderProjects(); 
        };
        
        window.promptDelete = (id, type) => { deletingTarget = {id, type}; document.getElementById('modal-delete').classList.remove('hidden'); };
        window.closeDeleteModal = () => { document.getElementById('modal-delete').classList.add('hidden'); deletingTarget = {id:null,type:null}; };
        window.confirmDelete = async () => {
            if(!deletingTarget.id) return;
            try { await deleteDoc(doc(db, deletingTarget.type+'s', deletingTarget.id)); showToast("‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); } catch(e){ showToast("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", true); }
            closeDeleteModal();
        };

        window.openImageTool = () => document.getElementById('modal-image').classList.remove('hidden');
        document.getElementById('img-tool-input').addEventListener('change', function(e){
            if(!e.target.files[0]) return;
            const r = new FileReader();
            r.onload = (ev) => {
                document.getElementById('img-tool-preview').classList.remove('hidden');
                document.getElementById('base64-output').value = `<img src="${ev.target.result}" width="100">`;
            };
            r.readAsDataURL(e.target.files[0]);
        });
        window.copyBase64 = () => { document.getElementById('base64-output').select(); document.execCommand('copy'); showToast("Copied!"); };

        window.openDetail = (p) => { 
            currentProjectData = p; 
            const isOwner = currentUser && p.authorId === currentUser.uid;
            document.getElementById('btn-edit-project').classList.toggle('hidden', !isOwner);

            document.getElementById('d-title').innerText=p.title; 
            document.getElementById('preview-frame').srcdoc=p.code; 
            document.getElementById('code-display').innerText=p.code; 
            document.getElementById('view-detail').classList.remove('hidden'); 
            switchDetailTab('preview'); 
        };
        window.closeDetail = () => { document.getElementById('view-detail').classList.add('hidden'); document.getElementById('preview-frame').srcdoc=''; currentProjectData = null; };
        window.switchDetailTab = (t) => {
            document.getElementById('content-preview').classList.toggle('hidden', t!=='preview');
            document.getElementById('content-code').classList.toggle('hidden', t!=='code');
            document.getElementById('tab-preview').className = t==='preview'?"flex-1 text-blue-400 border-b-2 border-blue-500 bg-gray-800/50":"flex-1 text-gray-500";
            document.getElementById('tab-code').className = t==='code'?"flex-1 text-blue-400 border-b-2 border-blue-500 bg-gray-800/50":"flex-1 text-gray-500";
        };
        window.copyCode = () => { const t=document.createElement('textarea'); t.value=document.getElementById('code-display').innerText; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); showToast("Copied!"); };

        window.showToast = (m, err=false) => { 
            const t = document.getElementById('toast'); 
            document.getElementById('toast-msg').innerText = m; 
            t.querySelector('i').className = err ? "fa-solid fa-circle-exclamation text-red-400" : "fa-solid fa-circle-check text-green-400"; 
            t.classList.remove('opacity-0', 'pointer-events-none'); t.classList.add('top-4', 'opacity-100'); 
            setTimeout(()=>{ t.classList.remove('top-4', 'opacity-100'); t.classList.add('opacity-0', 'pointer-events-none'); }, 2500); 
        };
        function timeAgo(ts) { if(!ts) return 'Just now'; const s = Math.floor((new Date()-ts.toDate())/1000); if(s<60)return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏µ‡πâ'; if(s<3600)return Math.floor(s/60)+' ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß'; if(s<86400)return Math.floor(s/3600)+' ‡∏ä‡∏°.‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß'; return Math.floor(s/86400)+' ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß'; }
    </script>
</body>
</html>
